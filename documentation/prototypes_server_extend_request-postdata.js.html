<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>prototypes/server/extend/request-postdata.js - SGApps Server - Framework</title>
    
    <meta name="description" content="SGApps Server for high performance results" />
    
        <meta name="keywords" content="javascript, js, application-prototype, prototype" />
        <meta name="keyword" content="javascript, js, application-prototype, prototype" />
    
    
    
    <meta property="og:title" content="SGApps Server - Framework"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content="https://labs.sgapps.io/open-source/network-server"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://labs.sgapps.io/open-source/network-server" target="_blank" class="menu-item" id="website_link" >Project Page ( Git Lab )</a></h2><h2><a href="http://gordienco.net/" target="_blank" class="menu-item" id="website_link" >About Me</a></h2><h2><a href="https://github.com/sergiu-gordienco/nodejs-mvc" target="_blank" class="menu-item" id="github_link" >GitHub</a></h2><h3>Classes</h3><ul><li><a href="LoggerBuilder.html">LoggerBuilder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#decorateGlobalLogger">decorateGlobalLogger</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#error">error</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#info">info</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#log">log</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#prompt">prompt</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#warn">warn</a></li></ul></li><li><a href="SGAppsServer.html">SGAppsServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServer.html#all">all</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#connect">connect</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#finalHandler">finalHandler</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#get">get</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handle">handle</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handleRequest">handleRequest</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#head">head</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#options">options</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#patch">patch</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#post">post</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#put">put</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#server">server</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#trace">trace</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#use">use</a></li></ul></li><li><a href="SGAppsServerDictionary.html">SGAppsServerDictionary</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerDictionary.html#push">push</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerDictionary.html#run">run</a></li></ul></li><li><a href="SGAppsServerRequest.html">SGAppsServerRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequest.html#getMountUpdatedUrl">getMountUpdatedUrl</a></li></ul></li><li><a href="SGAppsServerRequestCookie.html">SGAppsServerRequestCookie</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequestCookie.html#get">get</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerRequestCookie.html#get">get</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerRequestCookie.html#set">set</a></li></ul></li><li></li><li><a href="SGAppsServerRequestSession.html">SGAppsServerRequestSession</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequestSession.html#destroy">destroy</a></li></ul></li><li><a href="SGAppsServerResponse.html">SGAppsServerResponse</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#pipeFile">pipeFile</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#pipeFileStatic">pipeFileStatic</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#send">send</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#sendError">sendError</a></li></ul></li><li><a href="SGAppsSessionManager.html">SGAppsSessionManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsSessionManager.html#removeExpiredSessions">removeExpiredSessions</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#LoggerBuilderPrompt">LoggerBuilderPrompt</a></li><li><a href="global.html#MountUpdatedURL">MountUpdatedURL</a></li><li><a href="global.html#RequestHandler">RequestHandler</a></li><li><a href="global.html#RequestPathStructure">RequestPathStructure</a></li><li><a href="global.html#RequestSessionDecorator">RequestSessionDecorator</a></li><li><a href="global.html#ResourcesExtensions">ResourcesExtensions</a></li><li><a href="global.html#SGAppsServerDecorator">SGAppsServerDecorator</a></li><li><a href="global.html#SGAppsServerDictionaryRunCallBack">SGAppsServerDictionaryRunCallBack</a></li><li><a href="global.html#SGAppsServerOptions">SGAppsServerOptions</a></li><li><a href="global.html#SGAppsServerRequestFile">SGAppsServerRequestFile</a></li><li><a href="global.html#SGAppsServerRequestPostDataItem">SGAppsServerRequestPostDataItem</a></li><li><a href="global.html#SGAppsServerRequestSessionCache">SGAppsServerRequestSessionCache</a></li><li><a href="global.html#SGAppsSessionManagerOptions">SGAppsSessionManagerOptions</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">prototypes/server/extend/request-postdata.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const ePrototype = require("application-prototype/constructors/extensions/prototype");
const Busboy = require("busboy");
const { ServerResponse } = require("http");
const { Stream, Readable } = require("stream");

/**
 * @private
 * @method RequestUrlDecorator
 * @param {SGAppsServerRequest} request 
 * @param {SGAppsServerResponse} response 
 * @param {SGAppsServer} server
 * @param {function} callback
 */
module.exports = function RequestUrlDecorator(request, response, server, callback) {
	if (request === null || response === null) {
		callback();
		return;
	}

	/**
	 * post data buffer cache
	 * @memberof SGAppsServerRequest#
	 * @name _postDataBuffer
	 * @type {Buffer}
	 */
	request._postDataBuffer = new Buffer('');

	/**
	 * @typedef {object} SGAppsServerRequestFile
	 * @property {string} fieldName field's name
	 * @property {object} data
	 * @property {string} data.fileName file's name `[duplicate]`
	 * @property {string} data.encoding file's encoding
	 * @property {Readable} data.fileStream () => fileStream
	 * @property {Buffer} data.fileData
	 * @property {number} data.fileSize size in bytes
	 * @property {string} data.contentType file's mimeType
	 * @property {boolean} data.loaded indicate if file is fully loaded into `fileData`
	 */

	/**
	 * @typedef {object} SGAppsServerRequestPostDataItem
	 * @property {string} fieldName field's name
	 * @property {object} data
	 * @property {string} data.value
	 * @property {string} data.encoding file's encoding
	 * @property {string} data.valTruncated 
	 * @property {Buffer} data.fieldNameTruncated
	 * @property {string} data.mimeType file's mimeType
	 */

	const _body = {};
	const _bodyItems = [];

	/**
	 * @memberof SGAppsServerRequest#
	 * @name body
	 * @type {object}
	 */
	Object.defineProperty(request, 'body', {
		get: () => _body,
		set: () => server.logger.warn("[Request.body] is not configurable"),
		enumerable: true,
		configurable: true
	});

	/**
	 * @memberof SGAppsServerRequest#
	 * @name bodyItems
	 * @type {SGAppsServerRequestPostDataItem[]}
	 */
	Object.defineProperty(request, 'bodyItems', {
		get: () => _bodyItems,
		set: () => server.logger.warn("[Request.body] is not configurable"),
		enumerable: true,
		configurable: true
	});

	/**
	 * @memberof SGAppsServerRequest#
	 * @name files
	 * @type {Object&lt;string,SGAppsServerRequestFile[]>}
	 */
	const _files = {};
	Object.defineProperty(request, 'files', {
		get: () => _files,
		set: () => server.logger.warn("[Request.files] is not configurable"),
		enumerable: true,
		configurable: true
	});

	/**
	 * request's post received data
	 * @memberof SGAppsServerRequest#
	 * @name postData
	 * @type {Promise&lt;Buffer>}
	 */
	request.postData = new Promise(function (resolve, reject) {
		let _postDataSize = 0;
		let _canceled = false;
		request.request.on("data", function (chunk) {
			if (_canceled) return;
			if (request.request.aborted) return;

			var dataLimit = request.MAX_POST_SIZE;

			if (dataLimit &lt; _postDataSize) {
				_canceled = true;
				const err = Error('[Request.MAX_POST_SIZE] exceeded');
				server.logger.error(err);
				reject(err);
				return;
			}

			request._postDataBuffer = Buffer.concat([request._postDataBuffer, chunk]);

			_postDataSize += chunk.length;
		});

		request.request.once("error", function (err) {
			if (_canceled) return;
			server.logger.error(err);
			_canceled = true;
			reject(err);
		});

		request.request.once("abort", function () {
			if (_canceled) return;
			const err = Error('[Request] aborted');
			server.logger.error(err);
			_canceled = true;
			reject(err);
		});

		request.request.once('end', function () {
			if (_canceled) return;
			if (
				(
					request.request.headers['content-type'] || ''
				).indexOf('multipart/form-data') === 0
			) {

				let Readable = require('stream').Readable;
				let readable = new Readable()
				readable._read = () => {} // _read is required but you can noop it
				readable.push(request._postDataBuffer);
				readable.push(null);
	
				var detectedBoundary = (
					request._postDataBuffer
						.slice(0, 1024).toString()
						.match(/^\-\-(\-{4,}[A-Za-z0-9]{4,}\-*)(\r|)\n/) || []
				)[1] || null;
	
					if (detectedBoundary) {
						var calculatedHeader = 'multipart/form-data; boundary=' + detectedBoundary;
						if (
							calculatedHeader !== request.request.headers['content-type']
						) {
							console.warn(
								"Multipart Form Data: boundary replaced from ",
								request.request.headers['content-type'],
								calculatedHeader
							);
						}
						request.request.headers['content-type'] = calculatedHeader;
					}
	
					/**
					 * @private
					 * @type {Readable}
					 */
					//@ts-ignore
					const busboy = new Busboy({
						headers: request.request.headers,
						limits: {
							fieldNameSize: 255,
							fieldSize: request.MAX_POST_SIZE,
							fileSize: request.MAX_POST_SIZE
						}
					});

					busboy.on(
						'file',
						/**
						 * @inner
						 * @param {string} fieldName 
						 * @param {Readable} fileStream 
						 * @param {string} fileName 
						 * @param {string} encoding 
						 * @param {string} mimeType 
						 */
						function (
							fieldName,
							fileStream,
							fileName,
							encoding,
							mimeType
						) {
							const file = {
								fieldName: fieldName,
								data: {
									fileName: fileName,
									encoding: encoding,
									fileStream: () => fileStream,
									fileData: null,
									fileSize: 0,
									contentType: mimeType,
									loaded: false
								}
							};
							if (!(fieldName in _files)) _files[fieldName] = [];

							//@ts-ignore
							_files[fieldName].push(file);

							fileStream.on('data', function (data) {
								file.data.fileData.push(data);
								file.data.fileSize += data.length;
							});
							fileStream.on('error', function (err) {
								file.data.error = err;
								server.logger.error(err);
							});
							fileStream.on('end', function () {
								file.data.fileData = Buffer.concat(file.data.fileData);
								if (!file.data.error)
									file.data.loaded = true;
							});
						}
					);

					busboy.on('field', function (fieldName, value, fieldNameTruncated, valTruncated, encoding, mimeType) {
						// console.warn("BusBoy Field", arguments);
						_bodyItems.push({
							fieldName: fieldName,
							data: {
								value: value,
								fieldNameTruncated: fieldNameTruncated,
								valTruncated: valTruncated,
								encoding: encoding,
								mimeType: mimeType
							}
						});
						_body[fieldName] = value;
					});
	
					busboy.on('error', function (err) {
						server.logger.error(err);
						reject(err);
					});
	
					busboy.on('finish', function () {
						resolve(request._postDataBuffer);
					});
	
					//@ts-ignore
					readable.pipe(busboy) // consume the stream
			} else {
				resolve(request._postDataBuffer);
			}
		});
	});

	callback();
}

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


    <script src="https://sgapps.io/components/sgapps-labs-examples/toolbar/loader.js"></script>
    
</body>
</html>
