<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>prototypes/server/extend/template-manager/facebox-templates.js - SGApps Server - Framework</title>
    
    <meta name="description" content="SGApps Server for high performance results" />
    
        <meta name="keywords" content="javascript, js, application-prototype, prototype" />
        <meta name="keyword" content="javascript, js, application-prototype, prototype" />
    
    
    
    <meta property="og:title" content="SGApps Server - Framework"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content="https://labs.sgapps.io/open-source/sgapps-server"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://labs.sgapps.io/open-source/sgapps-server" target="_blank" class="menu-item" id="website_link" >Project Page ( Git Lab )</a></h2><h2><a href="http://gordienco.net/" target="_blank" class="menu-item" id="website_link" >About Me</a></h2><h2><a href="https://labs.sgapps.io/open-source/sgapps-server" target="_blank" class="menu-item" id="github_link" >GitHub</a></h2><h3>Classes</h3><ul><li><a href="FaceboxTemplate.html">FaceboxTemplate</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FaceboxTemplate.html#render">render</a></li><li data-type='method' style='display: none;'><a href="FaceboxTemplate.html#renderCode">renderCode</a></li><li data-type='method' style='display: none;'><a href="FaceboxTemplate.html#renderFile">renderFile</a></li></ul></li><li><a href="FSLibrary.html">FSLibrary</a></li><li><a href="LoggerBuilder.html">LoggerBuilder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#decorateGlobalLogger">decorateGlobalLogger</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#error">error</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#info">info</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#log">log</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#prettyCli">prettyCli</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#prompt">prompt</a></li><li data-type='method' style='display: none;'><a href="LoggerBuilder.html#warn">warn</a></li></ul></li><li><a href="SGAppsServer.html">SGAppsServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServer.html#all">all</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#connect">connect</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#Email">Email</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#finalHandler">finalHandler</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#get">get</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handle">handle</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handlePostData">handlePostData</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handleRequest">handleRequest</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#handleStaticRequest">handleStaticRequest</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#head">head</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#options">options</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#patch">patch</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#post">post</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#put">put</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#server">server</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#trace">trace</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.html#use">use</a></li></ul></li><li><a href="SGAppsServer.NodeJsMvc.html">NodeJsMvc</a></li><li class="level-hide"><a href="SGAppsServer.NodeJsMvc.Controller.html">Controller</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#actionExists">actionExists</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#addAction">addAction</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#addView">addView</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#getAction">getAction</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#getView">getView</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#removeAction">removeAction</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#removeView">removeView</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#render">render</a></li><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.html#viewExists">viewExists</a></li></ul></li><li class="level-hide"><a href="SGAppsServer.NodeJsMvc.Controller.Action.html">Action</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServer.NodeJsMvc.Controller.Action.html#run">run</a></li></ul></li><li><a href="SGAppsServerDecoratorsLibrary.html">SGAppsServerDecoratorsLibrary</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerDecoratorsLibrary.html#.NodeJsMvcDecorator">NodeJsMvcDecorator</a></li></ul></li><li><a href="SGAppsServerDictionary.html">SGAppsServerDictionary</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerDictionary.html#generatePathKey">generatePathKey</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerDictionary.html#push">push</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerDictionary.html#run">run</a></li></ul></li><li><a href="SGAppsServerEmail.html">SGAppsServerEmail</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerEmail.html#.from">from</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerEmail.html#.isValidAddress">isValidAddress</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerEmail.html#.timeout">timeout</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerEmail.html#send">send</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerEmail.html#valid">valid</a></li></ul></li><li><a href="SGAppsServerRequest.html">SGAppsServerRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequest.html#getMountUpdatedUrl">getMountUpdatedUrl</a></li></ul></li><li><a href="SGAppsServerRequestCookie.html">SGAppsServerRequestCookie</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequestCookie.html#get">get</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerRequestCookie.html#set">set</a></li></ul></li><li><a href="SGAppsServerRequestSession.html">SGAppsServerRequestSession</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerRequestSession.html#destroy">destroy</a></li></ul></li><li><a href="SGAppsServerResponse.html">SGAppsServerResponse</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#pipeFile">pipeFile</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#pipeFileStatic">pipeFileStatic</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#redirect">redirect</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#send">send</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#sendError">sendError</a></li><li data-type='method' style='display: none;'><a href="SGAppsServerResponse.html#sendStatusCode">sendStatusCode</a></li></ul></li><li><a href="SGAppsServerShared.html">SGAppsServerShared</a></li><li><a href="SGAppsSessionManager.html">SGAppsSessionManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SGAppsSessionManager.html#handleRequest">handleRequest</a></li><li data-type='method' style='display: none;'><a href="SGAppsSessionManager.html#removeExpiredSessions">removeExpiredSessions</a></li></ul></li><li><a href="TemplateManager.html">TemplateManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TemplateManager.html#add">add</a></li><li data-type='method' style='display: none;'><a href="TemplateManager.html#addList">addList</a></li><li data-type='method' style='display: none;'><a href="TemplateManager.html#get">get</a></li><li data-type='method' style='display: none;'><a href="TemplateManager.html#remove">remove</a></li><li data-type='method' style='display: none;'><a href="TemplateManager.html#render">render</a></li><li data-type='method' style='display: none;'><a href="TemplateManager.html#templateExists">templateExists</a></li></ul></li><li><a href="TemplateManagerViewer.html">TemplateManagerViewer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TemplateManagerViewer.html#render">render</a></li><li data-type='method' style='display: none;'><a href="TemplateManagerViewer.html#renderCode">renderCode</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#LoggerBuilderPrompt">LoggerBuilderPrompt</a></li><li><a href="global.html#MountUpdatedURL">MountUpdatedURL</a></li><li><a href="global.html#RequestHandler">RequestHandler</a></li><li><a href="global.html#RequestPathStructure">RequestPathStructure</a></li><li><a href="global.html#RequestPathStructureMap">RequestPathStructureMap</a></li><li><a href="global.html#RequestSessionDecorator">RequestSessionDecorator</a></li><li><a href="global.html#ResourcesExtensions">ResourcesExtensions</a></li><li><a href="global.html#routeMatch">routeMatch</a></li><li><a href="global.html#SGAppsServerDecorator">SGAppsServerDecorator</a></li><li><a href="global.html#SGAppsServerDictionaryRunCallBack">SGAppsServerDictionaryRunCallBack</a></li><li><a href="global.html#SGAppsServerErrorCallBack">SGAppsServerErrorCallBack</a></li><li><a href="global.html#SGAppsServerErrorOnlyCallback">SGAppsServerErrorOnlyCallback</a></li><li><a href="global.html#SGAppsServerHandlerPostData">SGAppsServerHandlerPostData</a></li><li><a href="global.html#SGAppsServerOptions">SGAppsServerOptions</a></li><li><a href="global.html#SGAppsServerRequestFile">SGAppsServerRequestFile</a></li><li><a href="global.html#SGAppsServerRequestPostDataItem">SGAppsServerRequestPostDataItem</a></li><li><a href="global.html#SGAppsServerRequestSessionCache">SGAppsServerRequestSessionCache</a></li><li><a href="global.html#SGAppsSessionManagerOptions">SGAppsSessionManagerOptions</a></li><li><a href="global.html#TemplateManagerRenderOptions">TemplateManagerRenderOptions</a></li><li><a href="global.html#TemplateManagerTemplate">TemplateManagerTemplate</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">prototypes/server/extend/template-manager/facebox-templates.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
	On template Rendering we have
	following variables

	var vars	= {}; // variables that a sent from controllers
	var env		= {
		error	: [],
		vars	: envVars,
		path	: "", // filePath
		dirname	: "", // dirname
		render	: function( text, vars, env ) {}, // render function
		renderFile	: function( file, vars, callback ) {}, // render file function
			// callback( error {{ [] or false }}, htm)
	};
	env.vars = {
		// env varssent from app
		response : [object] // http reponse object
	}
*/
/**
 * @class
 * @name FaceboxTemplate
 * @param {object} options
 * @param {FSLibrary} options._fs
 */
function FaceboxTemplate(options) {

	/**
	 * @memberof FaceboxTemplate#
	 * @var {boolean} _debug
	 */
	let _debug = false;
	Object.defineProperty(
		this,
		'_debug',
		{
			get: () => _debug,
			set: (v) => {
				_debug = !!v;
			}
		}
	);
	
	/**
	 * @memberof FaceboxTemplate#
	 * @var {Object&lt;string,any>} _env
	 */;
	let _env = {};
	Object.defineProperty(
		this,
		'_env',
		{
			get: () => _env,
			set: (data) => {
				Object.assign(_env, data);
			}
		}
	);

	/**
	 * @memberof FaceboxTemplate#
	 * @var {Object&lt;string,string>} _cachedFiles
	 */
	this._cachedFiles = {};

	const readFileSync = (addr) => {
		if (addr in this._cachedFiles) {
			return this._cachedFiles[addr];
		} else {
			//@ts-ignore
			const content	= options._fs.readFileSync( addr, { encoding: "utf-8" } );
			// @ts-ignore
			if (!this._debug) {
				this._cachedFiles[addr]	= content;
			}
			return content;
		}
	};

	/**
	 * @memberof FaceboxTemplate#
	 * @var {number} INCLUDE_LEVEL
	 */
	this.INCLUDE_LEVEL = 10;

	/**
	 * @memberof FaceboxTemplate#
	 * @method render
	 * @param {string} text
	 * @param {Object&lt;string,any>} vars
	 * @param {Object&lt;string,any>} env
	 * @this FaceboxTemplate
	 */
	this.render	= function FaceboxTemplateRender( text, vars, env ) {
		if (vars === undefined) vars = {};

		const template	= { text: text };
		const replacers	= [];
		let err			= false;
		/**
		 * @private
		 * @param {string} addr 
		 * @returns {string}
		 */
		const parseAddr = function parseAddr(addr) {
			let err;
			if(addr.subs(1) == ":") {
				return `${env.dirname.replace(/\/+$/,'')}/${addr.subs(1,0)}`;
			} else {
				try {
					return (new Function(
						`const env	= arguments[1];const vars = arguments[0];\n return ${addr}`
					))(vars, env);
				} catch(err) {
					throw Error(
						`Unable to eval path: ${addr} ; ${err.meesage} ;`
					);
				}
			}
		}.bind(this);

		text = text.replace(
			/\{\{(read|read\-base64|read\-hex)\:(.*?)\}\}/g,
			function (match, p1, p2, offset, string) {
				const x	= '[[replacer-'+Math.floor(Math.random()*10000000)+'-'+Math.floor(Math.random()*10000000)+'-'+new Date().valueOf()+']]';
				replacers.push({ id : x, type : 'action-'+p1, param : p2 });
				return x;
			}
		);
		text = text.replace(
			/\{\{(include)\:(.*?)\}\}/g,
			function (match, p1, p2, offset, string) {
				return readFileSync( parseAddr(p2) );
			}
		);
		text = text.replace(
			/\{\{(render)\:(.*?)\}\}/g,
			function (match, p1, p2, offset, string) {
				const addr	= parseAddr(p2);
				return this.render(
					readFileSync(addr),
					vars,
					{
						vars	: this._env,
						path	: addr,
						dirname	: ((addr).replace(/[^\/]+$/,'')+'/').replace(/^\/+$/,'/'),
						render	: this.render,
						renderFile	: this.renderFile
					}
				);
			}.bind(this)
		);

		text = text.replace(
			/\&lt;script[^\>]+?type\s*?=\s*?\"text\/facebox\-template\"[^\>]*?\>([\s\S]*?)\&lt;\/script\>/g,
			function (match, p1, p2, offset, string) {
				const x	= '[[replacer-'+Math.floor(Math.random()*10000000)+'-'+Math.floor(Math.random()*10000000)+'-'+new Date().valueOf()+']]';
				replacers.push({ id : x, type : 'js-return', code : p1 });
				return x;
			}
		);

		text = text.replace(
			/\{(code|js\-return|eval|js\-script|css\-style)\}([\s\S]*?)\{\/\1\}/g,
			function (match, p1, p2, offset, string) {
				const x	= '[[replacer-'+Math.floor(Math.random()*10000000)+'-'+Math.floor(Math.random()*10000000)+'-'+new Date().valueOf()+']]';
				replacers.push({ id : x, type : p1, code : p2 });
				return x;
			}
		);
		
		text = text.replace(
			/\{\{([\s\S]*?)\}\}/g,
			function (match, p1, offset, string) {
				const x	= '[[replacer-'+Math.floor(Math.random()*10000000)+'-'+Math.floor(Math.random()*10000000)+'-'+new Date().valueOf()+']]';
				replacers.push({ id : x, type : 'js-return', code : 'return '+p1 });
				return x;
			}
		);

		let i;
		for (i=0; i&lt;replacers.length; i++) {
			switch(replacers[i].type) {
				case 'code':
					text = text.split(replacers[i].id).join(replacers[i].code);
				break;
				case 'js-return':
					text	= text.split(replacers[i].id).join((new Function("var vars = arguments[0];var env = arguments[1];\nvar result = (function faceBoxTemplate_jsReturn() {\n"+replacers[i].code + "\n})(); if (result === undefined) return ''; return result;" ))( vars, env ));
				break;
				case 'eval':
					(new Function("var vars = arguments[0];var env = arguments[1];\n"+replacers[i].code ))( vars, env );
					text = text.split(replacers[i].id).join('');
				break;
				case 'js-script':
					text = text.split(replacers[i].id).join('&lt;script type="text/javascript" charset="utf-8">\n'+replacers[i].code+'\n&lt;/script>');
				break;
				case 'css-style':
					text = text.split(replacers[i].id).join('&lt;style type="text/css">\n'+replacers[i].code+'\n&lt;/style>');
				break;
				case 'action-read':
					text = text.split(replacers[i].id).join(readFileSync(parseAddr(replacers[i].param)));
				break;
				case 'action-read-base64':
					text = text.split(replacers[i].id).join(readFileSync(parseAddr(replacers[i].param)).base64encode());
				break;
				case 'action-read-hex':
					text = text.split(replacers[i].id).join(readFileSync(parseAddr(replacers[i].param)).toHex());
				break;
			}
		}
		return text;
	}.bind(this);



	/**
	 * @memberof FaceboxTemplate#
	 * @method renderFile
	 * @param {string} filePath
	 * @param {Object&lt;string,any>} vars
	 * @param {function} callback
	 * @this FaceboxTemplate
	 */
	this.renderFile	= function( filePath, vars, callback ) {
		const env		= {
			vars	: this._env,
			path	: filePath,
			dirname	: (filePath.replace(/[^\/]+$/,'')+'/').replace(/^\/+$/,'/'),
			render	: this.render,
			renderFile	: this.renderFile
		};
		callback(
			null,
			this.render( readFileSync( filePath ), vars, env )
		);
	}.bind(this);

	/**
	 * @memberof FaceboxTemplate#
	 * @method renderCode
	 * @param {string} code
	 * @param {Object&lt;string,any>} vars
	 * @param {function} callback
	 * @param {string} virtualFilePath
	 * @this FaceboxTemplate
	 */
	this.renderCode	= function( code, vars, callback, virtualFilePath ) {
		const env		= {
			vars	: this._env,
			path	: virtualFilePath || '',
			dirname	: ((virtualFilePath || '').replace(/[^\/]+$/,'')+'/').replace(/^\/+$/,'/'),
			render	: this.render,
			renderFile	: this.renderFile
		};
		callback(
			null,
			this.render(code, vars, env)
		);
	}.bind(this);

	return this;
};
module.exports	= FaceboxTemplate;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


    <script src="https://sgapps.io/components/sgapps-labs-examples/toolbar/loader.js"></script>
    
</body>
</html>
